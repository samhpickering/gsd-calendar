<!DOCTYPE html>
<html lang="en">
    <head>
	    <meta charset="utf-8" />
	    <title>GSD Calendar (React)</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="root"></div>
        <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script type="text/babel">
            function mod(n, m) {
                return ((n % m) + m) % m;
            }

            function getDayName(date) {
                return date.toLocaleDateString(undefined, {weekday: "short"});
            }
            function getMonthName(date) {
                return date.toLocaleDateString(undefined, {month: "long"});
            }

            function addDays(date, days) {
                var result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            }
            function addMonths(date, months) {
                var result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return result;
            }

            function getFirstOfMonth(date) {
                var result = new Date(date);
                result.setDate(1);
                return result;
            }

            function getPrecedingWeekday(date, weekDay) {
                const result = new Date(date);
                const daysBefore = mod((date.getDay() - weekDay), 7);
                result.setDate(result.getDate() - daysBefore);
                return result
            }

            function WeekdayLabelRow(props) {
                const weeks = [];
                for (let i = 0; i < props.weekWidths.length; i++) {
                    const labels = [];
                    for (let j = 0; j < props.weekWidths[i]; j++) {
                        labels.push(<td key={j}>{getDayName(addDays(props.firstDate, j))}</td>);
                    }
                    weeks.push(<td key={i}><table className="dayLabelTable"><tbody><tr>{labels}</tr></tbody></table></td>)
                }
                return (
                    <tr>
                        <td></td>
                        {weeks}
                    </tr>
                )
            }

            function MonthLabels(props) {
                let rows = [];
                for (let i = 0; i < props.monthCount; i++) {
                    const monthDate = new Date(props.firstDate);
                    monthDate.setMonth(monthDate.getMonth() + i);
                    rows.push(<tr key={i}><td>{getMonthName(monthDate)}</td></tr>);
                }
                return (
                    <table id="monthLabels">
                        <tbody>
                            {rows}
                        </tbody>
                    </table>
                )
            }

            function WeekTable(props) {
                let rows = [];
                for (let i = 0; i < props.monthCount; i++)  {
                    const firstDate = addMonths(getFirstOfMonth(props.startDate), i);
                    const leftDate = getPrecedingWeekday(firstDate, props.firstDayOfWeek);
                    
                    let days = []
                    for (let j = 0; j < (props.width || 7); j++) {
                        const date = addDays(leftDate, j + props.dayOffset);
                        const blankDay = (
                            date < props.startDate
                            || date > props.endDate
                            || date.getMonth() != firstDate.getMonth()
                        );
                        days.push(
                            <td key={j} className={blankDay ? "blankDay" : ""}>
                                {blankDay ? "" : date.getDate()}
                            </td>
                        )
                    }
                    rows.push(<tr key={i}>{days}</tr>)
                }
                return (
                    <table className="weekTable">
                        <tbody>
                            {rows}
                        </tbody>
                    </table>
                )
            }

            function Container(props) {    
                const monthCount = 1
				    + ((props.endDate.getFullYear() - props.startDate.getFullYear()) * 12)
				    + (props.endDate.getMonth() - props.startDate.getMonth());
                
                const firstDate = getFirstOfMonth(props.startDate);
                const topLeftDate = getPrecedingWeekday(firstDate, props.firstDayOfWeek);

                return (
                    <table id="container">
                        <tbody>
                            <WeekdayLabelRow firstDate={topLeftDate} weekWidths={[7, 7, 7, 7, 7, 2]} />
                            <tr>
                                <td>
                                    <MonthLabels firstDate={firstDate} monthCount={monthCount} />
                                </td>
                                <td>
                                    <WeekTable startDate={props.startDate} endDate={props.endDate} firstDayOfWeek={props.firstDayOfWeek} dayOffset={0} monthCount={monthCount} />
                                </td>
                                <td>
                                    <WeekTable startDate={props.startDate} endDate={props.endDate} firstDayOfWeek={props.firstDayOfWeek} dayOffset={7} monthCount={monthCount} />
                                </td>
                                <td>
                                    <WeekTable startDate={props.startDate} endDate={props.endDate} firstDayOfWeek={props.firstDayOfWeek} dayOffset={14} monthCount={monthCount} />
                                </td>
                                <td>
                                    <WeekTable startDate={props.startDate} endDate={props.endDate} firstDayOfWeek={props.firstDayOfWeek} dayOffset={21} monthCount={monthCount} />
                                </td>
                                <td>
                                    <WeekTable startDate={props.startDate} endDate={props.endDate} firstDayOfWeek={props.firstDayOfWeek} dayOffset={28} monthCount={monthCount} />
                                </td>
                                <td>
                                    <WeekTable startDate={props.startDate} endDate={props.endDate} firstDayOfWeek={props.firstDayOfWeek} dayOffset={35} width={2} monthCount={monthCount} />
                                </td>
                            </tr>
                        </tbody>
                    </table>
                )
            }
            // Container.propTypes = {
            //     startDate: PropTypes.instanceOf(Date).isRequired,
            //     endDate: PropTypes.instanceOf(Date).isRequired,
            //     firstDayOfWeek: PropTypes.number.isRequired,
            // }

            function Calendar(props) {
                const [title, setTitle] = React.useState("Title");
                const [startDate, setStartDate] = React.useState(new Date());
                const [endDate, setEndDate] = React.useState(addMonths(startDate, 12));
                const [firstDayOfWeek, setFirstDayOfweek] = React.useState(1); // Monday

                const startYear = startDate.getFullYear();
                const endYear = endDate.getFullYear();
                let yearHeader = "";

                if (startYear == endYear) {
                    yearHeader = String(startYear);
                } else if (Math.floor(endYear / 100) == Math.floor(startYear / 100)) {
                    const endYearStr = String(endYear);
                    yearHeader = String(startYear) + "-" + endYearStr.substring(endYearStr.length - 2);
                } else {
                    yearHeader = String(startYear) + "-" + String(endYear);
                }

                return (
                    <div>
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <table id="header">
                                            <tbody>
                                                <tr>
                                                    <td id="titleHeader">{title}</td>
                                                    <td id="yearHeader">{yearHeader}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                    <Container startDate={startDate} endDate={endDate} firstDayOfWeek={firstDayOfWeek} />
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <Settings title={title} setTitle={setTitle} startDate={startDate} setStartDate={setStartDate} endDate={endDate} setEndDate={setEndDate} firstDayOfWeek={firstDayOfWeek} setFirstDayOfweek={setFirstDayOfweek} />
                    </div>
                )
            }

            function Settings(props) {
                return (
                    <div id="settings">
                        <h1>Settings</h1>
                        <form>
                            <p>
                                <label>Title:</label>
                                <input type="text" id="titleInput" value={props.title} onChange={(e) => props.setTitle(e.target.value)} />
                            </p>
                            <p>
                                <label>Start Date:</label>
                                <input type="date" id="startDateInput" value={props.startDate.toISOString().slice(0,10)} onChange={(e) => props.setStartDate(new Date(e.target.valueAsNumber))} />
                            </p>
                            <p>
                                <label>End Date:</label>
                                <input type="date" id="endDateInput" value={props.endDate.toISOString().slice(0,10)} onChange={(e) => props.setEndDate(new Date(e.target.valueAsNumber))} />
                            </p>
                            <p>
                                <label>Start Weekday:</label>
                                <select id="startWeekdayInput" value={props.firstDayOfWeek} onChange={(e) => props.setFirstDayOfweek(e.target.value)}>
                                    <option value={1}>Monday</option>
                                    <option value={2}>Tuesday</option>
                                    <option value={3}>Wednesday</option>
                                    <option value={4}>Thursday</option>
                                    <option value={5}>Friday</option>
                                    <option value={6}>Saturday</option>
                                    <option value={0}>Sunday</option>
                                </select>
                            </p>
                        </form>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<Calendar />);
        </script>
    </body>
</html>
