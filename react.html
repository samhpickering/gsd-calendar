<!DOCTYPE html>
<html lang="en">
    <head>
	    <meta charset="utf-8" />
	    <title>GSD Calendar (React)</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="root"></div>
        <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script type="text/babel">
            function mod(n, m) {
                return ((n % m) + m) % m;
            }

            function classNames(map) {
                return Object.entries(map)
                    .filter(([key, value]) => value)
                    .map(([key, value]) => key)
                    .join(" ");
            }

            function getShortWeekdayName(date) {
                return date.toLocaleDateString(undefined, {weekday: "short"});
            }
            function getLongWeekdayName(date) {
                return date.toLocaleDateString(undefined, {weekday: "long"});
            }
            function getMonthName(date) {
                return date.toLocaleDateString(undefined, {month: "long"});
            }

            function addDays(date, days) {
                var result = new Date(date);
                result.setDate(result.getDate() + days);
                return NormalisedDate(result);
            }
            function addMonths(date, months) {
                var result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return NormalisedDate(result);
            }

            function getFirstOfMonth(date) {
                var result = new Date(date);
                result.setDate(1);
                return NormalisedDate(result);
            }

            function getPrecedingWeekday(date, weekDay) {
                const result = new Date(date);
                const daysBefore = mod((date.getDay() - weekDay), 7);
                result.setDate(result.getDate() - daysBefore);
                return NormalisedDate(result);
            }

            function toValueString(date) {
                return String(date.getFullYear()).padStart(4, "0") + "-" + String(date.getMonth() + 1).padStart(2, "0") + "-" + String(date.getDate()).padStart(2, "0");
            }

            function NormalisedDate() {
                const date = new Date(...arguments);
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }

            function Day(props) {
                const text = props.isLabel ? getShortWeekdayName(props.date) : props.date.getDate();
                return (
                    <div className={classNames({
                        "day": true,
                        "no-border": props.isLabel,
                        "blacked-out": props.isBlackedOut,
                    })}>
                        {props.isBlackedOut ? null : text}
                    </div>
                )
            }

            function Week(props) {
                const days = [];
                for (let day = 0; day < props.length; day++) {
                    const date = addDays(props.date, day);
                    const isBlackedOut = !props.dayLabelsOnly && !props.dateInRange(date);
                    days.push(
                        <Day key={day} date={date} isLabel={props.dayLabelsOnly} isBlackedOut={isBlackedOut} />
                    );
                }
                return (
                    <div className={classNames({
                        "week": true,
                        "no-border": props.dayLabelsOnly,
                    })}>
                        {days}
                    </div>
                );
            }

            function Month(props) {
                const firstDate = getPrecedingWeekday(props.date, props.firstDayOfWeek);
                const dateInRange = (date) => date.getMonth() == props.date.getMonth() && date >= props.startDate && date <= props.endDate;
                return (
                    <div className={classNames({
                        "month": true,
                        "first-month": props.isFirstMonth,
                        "last-month": props.isLastMonth,
                    })}>
                        <div className="label">{props.dayLabelsOnly ? "" : getMonthName(props.date)}</div>
                        <Week length={7} date={addDays(firstDate,  0)} dayLabelsOnly={props.dayLabelsOnly} dateInRange={dateInRange} />
                        <Week length={7} date={addDays(firstDate,  7)} dayLabelsOnly={props.dayLabelsOnly} dateInRange={dateInRange} />
                        <Week length={7} date={addDays(firstDate, 14)} dayLabelsOnly={props.dayLabelsOnly} dateInRange={dateInRange} />
                        <Week length={7} date={addDays(firstDate, 21)} dayLabelsOnly={props.dayLabelsOnly} dateInRange={dateInRange} />
                        <Week length={7} date={addDays(firstDate, 28)} dayLabelsOnly={props.dayLabelsOnly} dateInRange={dateInRange} />
                        <Week length={2} date={addDays(firstDate, 35)} dayLabelsOnly={props.dayLabelsOnly} dateInRange={dateInRange} />
                    </div>
                );
            }

            function Calendar(props) {
                let currentMonth = getFirstOfMonth(props.startDate);
                let isFirstMonth = true;
                
                const months = [];
                while (currentMonth <= props.endDate) {
                    const nextMonth = addMonths(currentMonth, 1);
                    const isLastMonth = nextMonth > props.endDate;

                    months.push(
                        <Month
                            key={toValueString(currentMonth)}
                            date={currentMonth}
                            startDate={props.startDate}
                            endDate={props.endDate}
                            firstDayOfWeek={props.firstDayOfWeek}
                            isFirstMonth={isFirstMonth}
                            isLastMonth={isLastMonth}
                        />
                    )

                    currentMonth = nextMonth;
                    isFirstMonth = false;
                }

                return (
                    <div className="calendar">
                        <Month
                            date={currentMonth}
                            dayLabelsOnly={true}
                            firstDayOfWeek={props.firstDayOfWeek}
                        />
                        {months}
                    </div>
                )
            }

            function Container(props) {
                const [title, setTitle] = React.useState("Title");
                const [startDate, setStartDate] = React.useState(NormalisedDate());
                const [endDate, setEndDate] = React.useState(addMonths(startDate, 12));
                const [firstDayOfWeek, setFirstDayOfweek] = React.useState(1); // Monday

                return (
                    <div className="container">
                        <Header title={title} startDate={startDate} endDate={endDate} />
                        <Calendar startDate={startDate} endDate={endDate} firstDayOfWeek={firstDayOfWeek} />
                        <Settings title={title} setTitle={setTitle} startDate={startDate} setStartDate={setStartDate} endDate={endDate} setEndDate={setEndDate} firstDayOfWeek={firstDayOfWeek} setFirstDayOfweek={setFirstDayOfweek} />
                    </div>
                )
            }

            function Header(props) {
                const startYear = props.startDate.getFullYear();
                const endYear = props.endDate.getFullYear();
                
                let yearSpan = "";

                if (startYear == endYear) {
                    yearSpan = String(startYear);
                } else if (Math.floor(endYear / 100) == Math.floor(startYear / 100)) {
                    const endYearStr = String(endYear);
                    yearSpan = String(startYear) + "-" + endYearStr.substring(endYearStr.length - 2);
                } else {
                    yearSpan = String(startYear) + "-" + String(endYear);
                }

                return (
                    <div className="header">
                        <div className="title">{props.title}</div>
                        <div className="year">{yearSpan}</div>
                    </div>
                )
            }

            function Settings(props) {
                const today = NormalisedDate();

                const weekdayOptions = [];
                for (let weekday = 0; weekday < 7; weekday++) {
                    const weekdayName = getLongWeekdayName(getPrecedingWeekday(today, weekday));
                    weekdayOptions.push(<option key={weekday} value={weekday}>{weekdayName}</option>);
                }

                function convertDate(event, callback) {
                    if (!isNaN(event.target.valueAsNumber)) {
                        const date = NormalisedDate(event.target.valueAsNumber);
                        callback(date);
                    }
                }

                return (
                    <div className="settings">
                        <h1>Settings</h1>
                        <form>
                            <p>
                                <label>Title:</label>
                                <input type="text" className="titleInput" value={props.title} onChange={(e) => props.setTitle(e.target.value)} />
                            </p>
                            <p>
                                <label>Start Date:</label>
                                <input type="date" defaultValue={toValueString(props.startDate)} onChange={(e) => convertDate(e, props.setStartDate)} />
                            </p>
                            <p>
                                <label>End Date:</label>
                                <input type="date" defaultValue={toValueString(props.endDate)} onChange={(e) => convertDate(e, props.setEndDate)} />
                            </p>
                            <p>
                                <label>Start Weekday:</label>
                                <select value={props.firstDayOfWeek} onChange={(e) => props.setFirstDayOfweek(e.target.value)}>
                                    {weekdayOptions}
                                </select>
                            </p>
                        </form>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<Container />);
        </script>
    </body>
</html>
