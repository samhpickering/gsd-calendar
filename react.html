<!DOCTYPE html>
<html lang="en">
    <head>
	    <meta charset="utf-8" />
	    <title>GSD Calendar (React)</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="root"></div>
        <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script type="text/babel">
            function mod(n, m) {
                return ((n % m) + m) % m;
            }

            function classNames(map) {
                return Object.entries(map)
                    .filter(([key, value]) => value)
                    .map(([key, value]) => key)
                    .join(" ");
            }

            class CalendarDate {
                #date;
                constructor() {
                    const date = new Date(...arguments);
                    this.#date = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                }
                clone() {
                    return new CalendarDate(this.toDate());
                }
                toDate() { return new Date(this.#date); }

                getFullYear() { return this.#date.getFullYear(); }
                getMonth() { return this.#date.getMonth(); }
                getDate() { return this.#date.getDate(); }
                getDay() { return this.#date.getDay(); }

                before(date) { return this.toDate() < date.toDate(); }
                after(date) { return this.toDate() > date.toDate(); }

                between(startDate, endDate) {
                    return !this.before(startDate) && !this.after(endDate);
                }

                min(date) {
                    if (this.after(date)) return date.clone();
                    return this.clone();
                }
                max(date) {
                    if (this.before(date)) return date.clone();
                    return this.clone();
                }

                toValueString() {
                    return (
                        String(this.getFullYear()).padStart(4, "0")
                        + "-" +
                        String(this.getMonth() + 1).padStart(2, "0")
                        + "-" +
                        String(this.getDate()).padStart(2, "0")
                    )
                }
                format(format) {
                    return this.#date.toLocaleDateString(undefined, format);
                }

                add(years, months, days) {
                    return new CalendarDate(this.getFullYear() + years, this.getMonth() + months, this.getDate() + days);
                }
                getFirstOfMonth() {
                    return new CalendarDate(this.getFullYear(), this.getMonth(), 1);
                }
                getLastOfMonth() {
                    return this.add(0, 1, 0).getFirstOfMonth().add(0, 0, -1);
                }
                getPrecedingWeekday(weekDay) {
                    const daysBefore = mod(this.getDay() - weekDay, 7);
                    return this.add(0, 0, -daysBefore);
                }
            }

            function Day({date, isLabel, isBlackedOut}) {
                const text = isLabel ? date.format({weekday: "short"}) : date.getDate();
                return (
                    <div className={classNames({
                        "day": true,
                        "no-border": isLabel,
                        "blacked-out": isBlackedOut,
                    })}>
                        {isBlackedOut ? null : text}
                    </div>
                )
            }

            function Week({length, date, isLabel, dateInRange}) {
                const days = [];
                for (let dayNumber = 0; dayNumber < length; dayNumber++) {
                    const day = date.add(0, 0, dayNumber);
                    const isBlackedOut = !isLabel && !dateInRange(day);
                    days.push(
                        <Day key={dayNumber} date={day} isLabel={isLabel} isBlackedOut={isBlackedOut} />
                    );
                }
                return (
                    <div className={classNames({
                        "week": true,
                        "no-border": isLabel,
                    })}>
                        {days}
                    </div>
                );
            }

            function Month({monthStartDate, monthEndDate, firstDayOfWeek, isFirstMonth, isLastMonth, isLabel}) {
                const firstDayDate = monthStartDate.getFirstOfMonth().getPrecedingWeekday(firstDayOfWeek);
                const dateInRange = (date) => date.getMonth() == monthStartDate.getMonth() && date.between(monthStartDate, monthEndDate);
                return (
                    <div className={classNames({
                        "month": true,
                        "first-month": isFirstMonth,
                        "last-month": isLastMonth,
                    })}>
                        <div className="label">{isLabel ? "" : monthStartDate.format({month: "long"})}</div>
                        <Week length={7} date={firstDayDate.add(0, 0,  0)} {...{isLabel, dateInRange}} />
                        <Week length={7} date={firstDayDate.add(0, 0,  7)} {...{isLabel, dateInRange}} />
                        <Week length={7} date={firstDayDate.add(0, 0, 14)} {...{isLabel, dateInRange}} />
                        <Week length={7} date={firstDayDate.add(0, 0, 21)} {...{isLabel, dateInRange}} />
                        <Week length={7} date={firstDayDate.add(0, 0, 28)} {...{isLabel, dateInRange}} />
                        <Week length={2} date={firstDayDate.add(0, 0, 35)} {...{isLabel, dateInRange}} />
                    </div>
                );
            }

            function Calendar({calStartDate, calEndDate, firstDayOfWeek}) {
                let firstOfMonth = calStartDate.getFirstOfMonth();
                let isFirstMonth = true;
                
                const months = [];
                while (true) {
                    const nextFirstOfMonth = firstOfMonth.add(0, 1 ,0).getFirstOfMonth();
                    const lastOfMonth = firstOfMonth.getLastOfMonth();

                    const monthStartDate = firstOfMonth.max(calStartDate);
                    const monthEndDate = lastOfMonth.min(calEndDate);

                    const isLastMonth = !nextFirstOfMonth.between(calStartDate, calEndDate);

                    months.push(
                        <Month
                            key={firstOfMonth.toValueString()}
                            {...{monthStartDate, monthEndDate, firstDayOfWeek, isFirstMonth, isLastMonth}}
                        />
                    )

                    firstOfMonth = nextFirstOfMonth;
                    isFirstMonth = false;

                    if (isLastMonth) break;
                }

                return (
                    <div className="calendar">
                        <Month
                            isLabel={true}
                            monthStartDate={calStartDate}
                            {...{firstDayOfWeek}}
                        />
                        {months}
                    </div>
                )
            }

            function Container() {
                const [title, setTitle] = React.useState("Title");
                const [calStartDate, setcalStartDate] = React.useState(new CalendarDate());
                const [calEndDate, setcalEndDate] = React.useState(calStartDate.add(1, 0, 0));
                const [firstDayOfWeek, setFirstDayOfWeek] = React.useState(1); // Monday

                return (
                    <div className="container">
                        <Header   {...{title, calStartDate, calEndDate}} />
                        <Calendar {...{calStartDate, calEndDate, firstDayOfWeek}} />
                        <Settings {...{title, setTitle, calStartDate, setcalStartDate, calEndDate, setcalEndDate, firstDayOfWeek, setFirstDayOfWeek}} />
                    </div>
                )
            }

            function Header({title, calStartDate, calEndDate}) {
                const startYear = calStartDate.getFullYear();
                const endYear = calEndDate.getFullYear();
                
                let yearSpan = "";

                if (startYear == endYear) {
                    yearSpan = String(startYear);
                } else if (Math.floor(endYear / 100) == Math.floor(startYear / 100)) {
                    const endYearStr = String(endYear);
                    yearSpan = String(startYear) + "-" + endYearStr.substring(endYearStr.length - 2);
                } else {
                    yearSpan = String(startYear) + "-" + String(endYear);
                }

                return (
                    <div className="header">
                        <div className="title">{title}</div>
                        <div className="year">{yearSpan}</div>
                    </div>
                )
            }

            function Settings({title, calStartDate, calEndDate, firstDayOfWeek, setTitle, setcalStartDate, setcalEndDate, setFirstDayOfWeek}) {
                const today = new CalendarDate();

                const weekdayOptions = [];
                for (let weekday = 0; weekday < 7; weekday++) {
                    const weekdayName = today.getPrecedingWeekday(weekday).format({weekday: "long"});
                    weekdayOptions.push(<option key={weekday} value={weekday}>{weekdayName}</option>);
                }

                function handleDateChange(event, callback) {
                    if (!isNaN(event.target.valueAsNumber)) {
                        const date = new CalendarDate(event.target.valueAsNumber);
                        callback(date);
                    }
                }

                return (
                    <div className="settings">
                        <h1>Settings</h1>
                        <form>
                            <p>
                                <label>Title:</label>
                                <input type="text" className="titleInput" value={title} onChange={(e) => setTitle(e.target.value)} />
                            </p>
                            <p>
                                <label>Start Date:</label>
                                <input type="date" defaultValue={calStartDate.toValueString()} onChange={(e) => handleDateChange(e, setcalStartDate)} />
                            </p>
                            <p>
                                <label>End Date:</label>
                                <input type="date" defaultValue={calEndDate.toValueString()} onChange={(e) => handleDateChange(e, setcalEndDate)} />
                            </p>
                            <p>
                                <label>Start Weekday:</label>
                                <select value={firstDayOfWeek} onChange={(e) => setFirstDayOfWeek(e.target.value)}>
                                    {weekdayOptions}
                                </select>
                            </p>
                        </form>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<React.StrictMode><Container /></React.StrictMode>);
        </script>
    </body>
</html>
